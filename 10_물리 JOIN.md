# 물리 JOIN

지난 시간에는 논리 조인만 다뤘고 나머지 물리 조인을 알아본다. SQL서버는 논리 조인 연산을 수행하기 위해 다음의  
네 가지 물리 조인 작업을 수행한다.

- 중첩 루프 조인
- 병합 조인
- 해시 조인
- 적응적 조인

## 중첩 루프 조인(nested loops joins)

하나의 조인 인풋이 작다면(10개 이하) 그리고 다른 조인 인풋이 상당히 크고 조인 컬럼에 인덱스까지 걸려있다면,  
가장 적은 IO와 비교를 요구해서 인덱스 중첩 루프 조인은 가장 빠른 조인 작업이다.

중첩 루프 조인, 중첩 반복,은 하나의 조인 인풋을 outer 인풋 테이블로 그리고 다른 인풋을 inner 인풋 테이블로 사용한다.  
outer 루프는 outer 인풋 테이블을 행을 하나씩 소비한다. inner루프는 각 outer 행에 대해 일치하는 행을 inner인풋 테이블  
에서 탐색한다.

간단한 경우, 전체 테이블 또는 인덱스를 탐색한다. 이를 naive한 중첩 루프 조인이라 한다. 만약 인덱스를 활용한다면 인덱스  
중첩 루프 조인이라 한다. 만약 그 인덱스가 쿼리 계획의 일부로 만들어졌다면(그러고 쿼리 종료시 파괴) 임시 인덱스 중첩 조인  
이라 한다. 이 모든 변형들이 쿼리 최적화기에 의해 고려 된다.

중첩 루프 조인은 특히 outer 인풋이 작고 inner 인풋이 미리 index화되어 있고 클 때 효과적이다. 대부분의 작은 트랜잭션에서,
예를 들면 작은 행 집합에만 영향을 끼치는 것들, 인덱스 중첩 루프 조인은 병합 조인과 해시 조인보다 우수하다. 허나 크기가 큰  
쿼리들에서는 적합한 선택은 아니다.

## 병합 조인 (merge joins)

두 조인 인풋이 작지 않지만 조인 컬럼에 정렬 되어 있다면 병합 조인이 가장 빠른 조인 연산이다. 만약 두 조인 인풋 모두  
크고 크기도 비슷 하다면, 사전 정렬은 한 머지조인과 해시 조인은 비슷한 성능을 낸다. 하지만 해시 조인 연산은 두 인풋  
크기가 상당한 차이가 있을 때 훨씬 빠르다.

머지 조인은 두 인풋이 병합 컬럼, ON 절로 정의되는, 들에 대해 정렬 되어 있길 요구한다. 쿼리 최적화기는 인덱스가 적절한  
컬럼 집합에 대해 존재 한다면 보통 인덱스를 스캔하고, 또는 병합 조인 아래에 정렬 연산자를 배치한다. 희귀한 경우 다수의  
'='절이 존재 할수 있지만 병합 컬럼은 이중 일부만으로 구성된다.

각 인풋이 정렬 되어 있기에 병합 조인 연산자는 각 인풋으로 부터 행을 가져와 이들을 비교한다. 예를들어 내부 조인 연산에  
있어서, 두 행이 같다면 둘다 반환 한다. 다르다면 그 행은 버려지고 인풋으로부터 다른 행을 가져온다. 모든 행이 처리 되기  
까지 이 작업을 반복한다.

병합 조인 연산은 일반 또는 다-대-다 연산이다. 다대다 병합 조인은 행을 저장하기 위한 임시 테이블을 사용한다. 만약 각 인풋  
으로부터 중복 값이 있다면 인풋 값중 하나는 다른 인풋의 중복 값을 처리할 떄마다 중복된 값의 시작지점으로 되돌아가야한다.

병합 조인 자체는 빠르지만 정렬 작업이 요구되는 경우 비싼 결정이 될 수 있다. 하지만 데이터 볼륨이 크고 원하는 데이터가  
기존의 B-tree 인덱스로부터 사전 정렬되어 얻어질수 있다면 가장 빠른 연산이다.

## 해시 조인 (hash joins)

해시 조인은 크고, 정렬되지 않고, 인덱스도 없는 인풋을 효과적으로 처리할 수 있다. 복합 쿼리에서 중간 결과로 유용한데 이유는  
다음과 같다.

- 중간결과는 인덱스가 없다(명시적으로 디스크에 저장되어 인덱스 되지 않는한). 그리고 쿼리 계획에서 다음 연산을 위해 적절히  
  정렬되지 않는 경우가 자주 있다.
- 쿼리 최적화기는 오로지 중간 결과의 크기만을 추정한다. 복합쿼리에 있어서 추정치는 상당히 부정확 할 수 있어서 중간 결과를  
  처리하는 알고리듬은 효과적일 뿐만아니라 중간결과가 예상 보다 크더라도 성능이 급격히 저하되지 않고 점진적으로 감소(degrade  
   gracefully)해야 한다.

해시 조인은 비정규화 사용을 감소한다. 비정규화는 불필요한 데이터의 위험에도 불구하고(일관성 없는 갱신이라던가) 조인 연산을  
줄임으로써 성능 향상을 취하는 데 사용된다. 해시 조인은 비정규화의 필요를 감소시킨다. 해시 조인은 수직 파지셔닝(한 테이블의 컬럼  
그룹을 다른 파일이나 인덱스로 표현)을 물리적 DB디자인의 옵션으로 허용하게 해준다.

해시 조인은 빌드 인풋과 탐색(probe)인풋이 있다. 쿼리 최적화기는 더 작은 인풋을 빌드 인풋으로 취한다.

해시 조인은 다양한 종류의 집합 매칭 연산에 사용된다. 또한 해시조인의 변형은 중복 제거와 그루핑에 사용될 수 있다.

#### 참조

- [MSDN: Joins (SQL Server)](https://learn.microsoft.com/en-us/sql/relational-databases/performance/joins?view=sql-server-ver16#fundamentals)
